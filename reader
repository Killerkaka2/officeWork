package com.sbi.yono.document.batch.reader;

import java.util.List;

import javax.sql.DataSource;

import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.ParseException;
import org.springframework.batch.item.UnexpectedInputException;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import com.sbi.yono.document.batch.dto.NtbReq;
import com.sbi.yono.document.batch.rowmapper.NtbReqRowMapper;
import com.sbi.yono.document.savingsaccount.edms.upload.EdmsUploadConstants;
import com.tcs.techbone.channel.global.reader.GlobalConfigPropertiesReader;

@Component
public class ListReadingItemReader implements ItemReader<List<NtbReq>> {

	private final JdbcTemplate jdbcTemplate;
	int pagesize = Integer.parseInt((String) GlobalConfigPropertiesReader.getInstance().getPropertyById(EdmsUploadConstants.EDMS_SEGEMENT_SIZE));
	boolean finished = false;

	public ListReadingItemReader(DataSource dataSource) {
		this.jdbcTemplate = new JdbcTemplate();
		this.jdbcTemplate.setDataSource(dataSource);
	}

	@Override
	public List<NtbReq> read() throws Exception, UnexpectedInputException, ParseException {

		if (finished) {
			return null;
		}
		List<NtbReq> list = jdbcTemplate.query("select t1.ref_no, t1.cif,t1.channel_id,t1.updated_dt ,t1.job_id, \r\n"
				+ "t2.acnt_nmbr,t2.updtd_dt as crtn_dt,t2.isd_cd,\r\n"
				+ "t3.frst_nm,t3.last_nm,t3.mddle_nm,t3.brnch_cd,t3.ckyc_no,t3.mbl_no,t3.pan_dtls->>'pan' As pan\r\n"
				+ "from yono_dcmnt.edms_req AS t1\r\n"
				+ "INNER JOIN yono_accnt.accnt_onbrdng AS t2 ON t1.ref_no = t2.ref_no\r\n"
				+ "INNER JOIN yono_cstmr.cstmr_onbrdng AS t3 ON t2.ref_no = t3.ref_no\r\n"
				+ "where channel_id in ('Y2NDSSA','Y2NBNSA','Y2NBSSA')\r\n" + "order by updated_dt asc limit "
				+ pagesize, new NtbReqRowMapper(NtbReq.class));
		
		if (list.isEmpty()) {
			finished = true;
			return null;
		}
		return list;

	}
}
--------
package com.sbi.yono.document.batch.reader;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import javax.sql.DataSource;

import org.junit.jupiter.api.Test;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;

import com.sbi.yono.document.batch.dto.NtbReq;

/**
 * Unit tests for {@link ListReadingItemReader} with 100% coverage.
 *
 * This test:
 *  - Avoids any real database by injecting a custom JdbcTemplate via reflection.
 *  - Covers:
 *      * read() when finished == true
 *      * read() when query returns non-empty list
 *      * read() when query returns empty list (sets finished = true)
 */
public class ListReadingItemReaderTest {

    /**
     * Custom JdbcTemplate that returns pre-scripted results without touching a real DB.
     */
    private static class TestJdbcTemplate extends JdbcTemplate {
        private final List<List<NtbReq>> scriptedResults = new ArrayList<>();
        private int callCount = 0;

        void addResult(List<NtbReq> result) {
            scriptedResults.add(result);
        }

        @Override
        public <T> List<T> query(String sql, RowMapper<T> rowMapper) {
            // Ignore SQL and rowMapper completely for unit testing
            if (callCount < scriptedResults.size()) {
                @SuppressWarnings("unchecked")
                List<T> result = (List<T>) scriptedResults.get(callCount++);
                return result;
            }
            // Default: no more data
            return Collections.emptyList();
        }

        int getCallCount() {
            return callCount;
        }
    }

    // ------------------------------------------------------------------------
    // Helper methods for reflection
    // ------------------------------------------------------------------------

    private void setField(Object target, String fieldName, Object value) throws Exception {
        Field field = target.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(target, value);
    }

    private Object getField(Object target, String fieldName) throws Exception {
        Field field = target.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        return field.get(target);
    }

    // ------------------------------------------------------------------------
    // Tests
    // ------------------------------------------------------------------------

    @Test
    public void testReadReturnsListWhenNotFinishedAndDataPresent() throws Exception {
        // Create reader with null DataSource (we override jdbcTemplate anyway)
        ListReadingItemReader reader = new ListReadingItemReader((DataSource) null);

        // Inject our custom JdbcTemplate that returns a NON-empty result on first call
        TestJdbcTemplate testJdbcTemplate = new TestJdbcTemplate();
        // We don't care about actual NtbReq values, just that list is non-empty
        List<NtbReq> firstResult = new ArrayList<>();
        firstResult.add(null); // non-empty list
        testJdbcTemplate.addResult(firstResult);

        setField(reader, "jdbcTemplate", testJdbcTemplate);

        // Act
        List<NtbReq> result = reader.read();

        // Assert
        assertNotNull(result, "Result should not be null when data is present");
        assertEquals(1, result.size(), "Result list size should match scripted data");

        // finished flag should remain false
        boolean finished = (boolean) getField(reader, "finished");
        assertTrue(!finished, "finished flag should remain false when non-empty list is returned");
    }

    @Test
    public void testReadReturnsNullAndSetsFinishedWhenNoData() throws Exception {
        ListReadingItemReader reader = new ListReadingItemReader((DataSource) null);

        // Inject custom JdbcTemplate that returns an EMPTY list on first call
        TestJdbcTemplate testJdbcTemplate = new TestJdbcTemplate();
        testJdbcTemplate.addResult(Collections.emptyList()); // first (and only) call -> empty
        setField(reader, "jdbcTemplate", testJdbcTemplate);

        // First call: underlying query returns empty list => reader sets finished = true and returns null
        List<NtbReq> result = reader.read();

        assertNull(result, "Result should be null when no data is returned");
        boolean finished = (boolean) getField(reader, "finished");
        assertTrue(finished, "finished flag should be set to true when no data is returned");
    }

    @Test
    public void testReadReturnsNullWhenAlreadyFinished() throws Exception {
        ListReadingItemReader reader = new ListReadingItemReader((DataSource) null);

        // Inject custom JdbcTemplate just to verify it's not used
        TestJdbcTemplate testJdbcTemplate = new TestJdbcTemplate();
        // If read() tried to call query, it would increment callCount
        setField(reader, "jdbcTemplate", testJdbcTemplate);

        // Force finished = true before calling read()
        setField(reader, "finished", true);

        // Act
        List<NtbReq> result = reader.read();

        // Assert
        assertNull(result, "When finished is true, read() must return null immediately");
        assertEquals(0, testJdbcTemplate.getCallCount(),
                "JdbcTemplate.query should not be called when finished is already true");
    }
}

-----------------------------------------------------

package com.sbi.yono.document.batch.reader;

import java.util.List;

import javax.sql.DataSource;

import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.ParseException;
import org.springframework.batch.item.UnexpectedInputException;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import com.sbi.yono.document.batch.dto.NtbReq;
import com.sbi.yono.document.batch.rowmapper.NtbReqRowMapper;
import com.sbi.yono.document.savingsaccount.edms.upload.EdmsUploadConstants;
import com.tcs.techbone.channel.global.reader.GlobalConfigPropertiesReader;

@Component
public class ListReadingRetryItemReader implements ItemReader<List<NtbReq>> {

	private final JdbcTemplate jdbcTemplate;
	int pagesize = Integer.parseInt((String) GlobalConfigPropertiesReader.getInstance().getPropertyById(EdmsUploadConstants.EDMS_SEGEMENT_SIZE));
	private boolean finished = false;

	public ListReadingRetryItemReader(DataSource dataSource) {
		this.jdbcTemplate = new JdbcTemplate();
		this.jdbcTemplate.setDataSource(dataSource);
	}

	@Override
	public List<NtbReq> read() throws Exception, UnexpectedInputException, ParseException {
		if (finished) {
			return null;
		}
		List<NtbReq> list = jdbcTemplate.query("select t1.ref_no, t1.cif,t1.channel_id,t1.updtd_dt ,t1.job_id, \r\n"
				+ "t2.acnt_nmbr,t2.updtd_dt as crtn_dt,t2.isd_cd,\r\n"
				+ "t3.frst_nm,t3.last_nm,t3.mddle_nm,t3.brnch_cd,t3.ckyc_no,t3.mbl_no,t3.pan_dtls->>'pan' As pan\r\n"
				+ "from yono_dcmnt.edms_req AS t1\r\n"
				+ "INNER JOIN yono_accnt.accnt_onbrdng AS t2 ON t1.ref_no = t2.ref_no\r\n"
				+ "INNER JOIN yono_cstmr.cstmr_onbrdng AS t3 ON t2.ref_no = t3.ref_no\r\n"
				+ "where channel_id in ('Y2NBNSA')\r\n" + "order by t1.updtd_dt asc limit "
				+ pagesize, new NtbReqRowMapper(NtbReq.class));
		if (list.isEmpty()) {
			finished = true;
			return null;
		}
		return list;

	}
}
