package com.sbi.yono.document.batch;

import org.apache.commons.lang.exception.ExceptionUtils;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.JobParametersBuilder;
import org.springframework.batch.core.JobParametersInvalidException;
import org.springframework.batch.core.launch.JobLauncher;
import org.springframework.batch.core.repository.JobExecutionAlreadyRunningException;
import org.springframework.batch.core.repository.JobInstanceAlreadyCompleteException;
import org.springframework.batch.core.repository.JobRestartException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.boot.context.event.ApplicationFailedEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import com.tcs.techbone.logger.FLogger;

@SpringBootApplication
@ComponentScan(basePackages = { "com.sbi.yono.*", "com.tcs.techbone.*" })
@EntityScan(basePackages = { "com.tcs.techbone.*", "com.sbi.yono.*" })
@EnableTransactionManagement
@EnableScheduling
public class EDMSBatchApplication implements CommandLineRunner {

	private static final String TIER_NAME = "FTBatch";
	private static final String THIS_CLASS = "BatchApplication";
	public static final String METHOD_STARTED = "Method started";

	private JobLauncher jobLauncher;
	private Job ntbsaJobLoader;
	 private Job retryNtbsaJobLoader;

	@Autowired
	public EDMSBatchApplication(JobLauncher jobLauncher, @Qualifier("ntbsaJobLoader") Job ntbsaJobLoader,
			@Qualifier("retryNtbsaJobLoader") Job retryNtbsaJobLoader) {
		super();
		this.jobLauncher = jobLauncher;
		this.ntbsaJobLoader = ntbsaJobLoader;
		this.retryNtbsaJobLoader = retryNtbsaJobLoader;
	}

	/**
	 * @param args
	 */
	public static void main(String[] args) {
		SpringApplication app = new SpringApplication(EDMSBatchApplication.class);
		app.setRegisterShutdownHook(true);
		app.addListeners((ApplicationListener<ApplicationFailedEvent>) event -> {
			if (event.getException() instanceof RuntimeException) {
				FLogger.error(TIER_NAME, EDMSBatchApplication.class.getSimpleName(), "Main method",
						" Exited with error\n" + ExceptionUtils.getFullStackTrace(event.getException()));
				System.exit(1);
			}
		});
		ConfigurableApplicationContext context = app.run(args);
		context.registerShutdownHook();
		SpringApplication.exit(context, () -> 0);

	}

	/**
	 *
	 */
	public void run(String... args) throws JobExecutionAlreadyRunningException, JobRestartException,
			JobInstanceAlreadyCompleteException, JobParametersInvalidException {
		String methodName = "run";
		FLogger.info(TIER_NAME, THIS_CLASS, methodName, METHOD_STARTED);
		JobParameters jobParameters = new JobParametersBuilder()
				.addString("JobID", String.valueOf(System.currentTimeMillis())).toJobParameters();

		if (args.length == 0) {
			FLogger.info(TIER_NAME, THIS_CLASS, methodName, "No argument found.");
			return;
		}
		String jobName = args[0].split("=")[1];

		switch (jobName.trim()) {
		case "ntbsaJobLoader":
			System.out.println("job ntbsaJobLoader" );
			FLogger.info(TIER_NAME, THIS_CLASS, methodName, "ntbsaJobLoader");
			jobLauncher.run(ntbsaJobLoader, jobParameters);
			break;
		case "retryNtbsaJobLoader":
			FLogger.info(TIER_NAME, THIS_CLASS, methodName, "retryNtbsaJobLoader");
			jobLauncher.run(retryNtbsaJobLoader, jobParameters);
			break;
		default:
			FLogger.info(TIER_NAME, THIS_CLASS, methodName, "No such job found.");
		}

	}

}

-----------------------

package com.sbi.yono.document.batch;

import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.MockedConstruction;
import org.mockito.MockedStatic;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.launch.JobLauncher;
import org.springframework.boot.SpringApplication;
import org.springframework.context.ConfigurableApplicationContext;

import com.tcs.techbone.logger.FLogger;

@ExtendWith(MockitoExtension.class)
public class EDMSBatchApplicationTest {

    @Mock
    private JobLauncher jobLauncher;

    @Mock
    private Job ntbsaJobLoader;

    @Mock
    private Job retryNtbsaJobLoader;

    // ----------------------------------------------------------
    // Helper: create application under test
    // ----------------------------------------------------------
    private EDMSBatchApplication createApp() {
        return new EDMSBatchApplication(jobLauncher, ntbsaJobLoader, retryNtbsaJobLoader);
    }

    // ----------------------------------------------------------
    // Tests for run(...)
    // ----------------------------------------------------------

    @Test
    public void testRunWithNoArgumentsDoesNotLaunchAnyJob() throws Exception {
        EDMSBatchApplication app = createApp();

        try (MockedStatic<FLogger> floggerMock = Mockito.mockStatic(FLogger.class)) {
            app.run(); // args.length == 0 branch
        }

        // No job should be launched
        verifyNoInteractions(jobLauncher);
    }

    @Test
    public void testRunWithNtbsaJobLoaderArgumentLaunchesCorrectJob() throws Exception {
        EDMSBatchApplication app = createApp();
        String[] args = new String[] { "job=ntbsaJobLoader" };

        try (MockedStatic<FLogger> floggerMock = Mockito.mockStatic(FLogger.class)) {
            app.run(args);
        }

        ArgumentCaptor<JobParameters> paramsCaptor = ArgumentCaptor.forClass(JobParameters.class);
        verify(jobLauncher, times(1)).run(eq(ntbsaJobLoader), paramsCaptor.capture());
        verify(jobLauncher, never()).run(eq(retryNtbsaJobLoader), any(JobParameters.class));

        JobParameters params = paramsCaptor.getValue();
        assertNotNull(params.getString("JobID"));
    }

    @Test
    public void testRunWithRetryNtbsaJobLoaderArgumentLaunchesCorrectJob() throws Exception {
        EDMSBatchApplication app = createApp();
        String[] args = new String[] { "job=retryNtbsaJobLoader" };

        try (MockedStatic<FLogger> floggerMock = Mockito.mockStatic(FLogger.class)) {
            app.run(args);
        }

        ArgumentCaptor<JobParameters> paramsCaptor = ArgumentCaptor.forClass(JobParameters.class);
        verify(jobLauncher, times(1)).run(eq(retryNtbsaJobLoader), paramsCaptor.capture());
        verify(jobLauncher, never()).run(eq(ntbsaJobLoader), any(JobParameters.class));

        JobParameters params = paramsCaptor.getValue();
        assertNotNull(params.getString("JobID"));
    }

    @Test
    public void testRunWithUnknownJobNameDoesNotLaunchAnyJob() throws Exception {
        EDMSBatchApplication app = createApp();
        String[] args = new String[] { "job=unknownJob" };

        try (MockedStatic<FLogger> floggerMock = Mockito.mockStatic(FLogger.class)) {
            app.run(args);
        }

        verifyNoInteractions(jobLauncher);
    }

    // ----------------------------------------------------------
    // Test for main(...)
    // ----------------------------------------------------------

    @Test
    public void testMainMethodExecutesWithoutStartingRealSpringContext() {
        String[] args = new String[] { "job=ntbsaJobLoader" };

        // Mock construction of SpringApplication
        try (MockedConstruction<SpringApplication> mockedConstruction =
                     Mockito.mockConstruction(SpringApplication.class,
                             (mock, context) -> {
                                 ConfigurableApplicationContext ctx = mock(ConfigurableApplicationContext.class);
                                 when(mock.run(any(String[].class))).thenReturn(ctx);
                             });
             // Mock static methods of SpringApplication.exit(...)
             MockedStatic<SpringApplication> springAppStatic =
                     Mockito.mockStatic(SpringApplication.class, Mockito.CALLS_REAL_METHODS);
             // Mock static logger to avoid external logging behaviour
             MockedStatic<FLogger> floggerMock = Mockito.mockStatic(FLogger.class)) {

            // Stub SpringApplication.exit to avoid any side effects
            springAppStatic.when(() ->
                    SpringApplication.exit(any(ConfigurableApplicationContext.class), any()))
                    .thenReturn(0);

            // Call main
            EDMSBatchApplication.main(args);

            // Verify SpringApplication was constructed
            SpringApplication constructed = mockedConstruction.constructed().get(0);
            verify(constructed, times(1)).setRegisterShutdownHook(true);
            verify(constructed, times(1)).addListeners(any());
            verify(constructed, times(1)).run(any(String[].class));

            // Verify SpringApplication.exit was invoked
            springAppStatic.verify(
                    () -> SpringApplication.exit(any(ConfigurableApplicationContext.class), any()),
                    times(1));
        }
    }
}


---------------------------------

@Override
public List<NtbReq> read() throws Exception, UnexpectedInputException, ParseException {

    if (finished) {
        return null;
    }

    String sql = new StringBuilder()
            .append("SELECT t1.ref_no, t1.cfr, t1.channel_id, t1.updated_dt, t1.old_id, ")
            .append("t2.crn_no, t3.crn_name, t3.mobile_no, t3.pan, t3.pan_cds AS panCd ")
            .append("FROM yb_nom_cnfrm t1 ")
            .append("INNER JOIN yb_nom_cred t2 ON t1.ref_no = t2.ref_no ")
            .append("INNER JOIN yb_nom_crn t3 ON t2.ref_no = t3.ref_no ")
            .append("WHERE t1.channel_id IN ('ZNOMSSA','ZNOMSSB','ZNOMBSSA','ZNOMBSSB') ")
            .append("ORDER BY t1.updated_dt DESC ")
            .append("LIMIT ").append(pagesize)
            .toString();

    List<NtbReq> list = jdbcTemplate.query(sql, new NtbReqRowMapper(NtbReq.class));

    if (list.isEmpty()) {
        finished = true;
        return null;
    }

    return list;
}
